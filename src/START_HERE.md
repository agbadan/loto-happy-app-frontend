# üöÄ COMMENCEZ ICI - Backend Loto Happy

**Bienvenue !** Vous √™tes l'IA charg√©e de d√©velopper le backend de Loto Happy.

---

## üìÅ DOCUMENTATION FOURNIE (4 fichiers)

### üéØ 1. **START_HERE.md** ‚Üê Vous √™tes ici
   - Vue d'ensemble du projet
   - Ordre de lecture des documents
   - Quick start guide

### ü§ù 2. **BACKEND_HANDOFF.md** (33 pages)
   - **LIRE EN PREMIER**
   - R√©sum√© ex√©cutif du projet
   - Points critiques √† ne pas manquer
   - Checklist compl√®te
   - Priorit√©s de d√©veloppement

### üìã 3. **BACKEND_SPECIFICATIONS.md** (98 pages)
   - **R√âF√âRENCE PRINCIPALE**
   - Toutes les interfaces TypeScript
   - 60+ endpoints API d√©taill√©s
   - Logiques m√©tier compl√®tes
   - R√®gles de validation
   - Calcul des gains pour 9 types de paris

### üì° 4. **API_EXAMPLES.md** (55 pages)
   - **GUIDE D'IMPL√âMENTATION**
   - Exemples requ√™te/r√©ponse pour chaque endpoint
   - Cas d'usage concrets
   - Gestion d'erreurs
   - Donn√©es de test

### üîÑ 5. **DATA_MIGRATION_GUIDE.md** (42 pages)
   - **GUIDE DE MIGRATION**
   - Structure des donn√©es localStorage actuelles
   - Scripts de transformation
   - Plan de basculement
   - Validation post-migration

---

## üéì ORDRE DE LECTURE RECOMMAND√â

### Premi√®re lecture (1-2h):
1. ‚úÖ **START_HERE.md** (ce fichier) - 5 min
2. ‚úÖ **BACKEND_HANDOFF.md** - 30 min
   - Comprendre le projet dans son ensemble
   - Identifier les points critiques
   - Noter les questions √† poser

### Avant de coder:
3. üìã **BACKEND_SPECIFICATIONS.md** - 1h
   - Lire toutes les interfaces
   - Comprendre les logiques m√©tier
   - Noter les endpoints prioritaires

4. üì° **API_EXAMPLES.md** - 30 min
   - Voir les formats de requ√™te/r√©ponse
   - Comprendre les cas d'usage
   - Identifier les patterns

### Pendant le d√©veloppement:
- **BACKEND_SPECIFICATIONS.md** comme r√©f√©rence constante
- **API_EXAMPLES.md** pour chaque endpoint impl√©ment√©
- **DATA_MIGRATION_GUIDE.md** quand pr√™t √† migrer

---

## ‚ö° QUICK START (30 minutes)

### √âtape 1: Comprendre l'application (10 min)

**Loto Happy c'est:**
- üé∞ Agr√©gateur de **5 loteries** ouest-africaines
- üéØ **9 types de paris** avanc√©s (NAP1-5, PERMUTATION, BANKA, etc.)
- üë• **3 r√¥les**: Joueur, Revendeur, Admin
- üí∞ **Double solde**: Jeu + Gains
- üåç Pays: Togo, B√©nin, C√¥te d'Ivoire, Nigeria, S√©n√©gal

**√âtat actuel:**
- ‚úÖ Frontend 100% fonctionnel
- ‚è≥ Donn√©es en localStorage (√† migrer vers backend)

**Votre mission:**
- Cr√©er l'API backend compl√®te
- Migrer les donn√©es existantes
- Int√©grer avec le frontend

### √âtape 2: Identifier les entit√©s cl√©s (10 min)

**6 entit√©s principales:**

1. **User** (Joueur/Revendeur/Admin)
   - Authentification (Email/Password + Google OAuth)
   - Soldes (balanceGame, balanceWinnings, tokenBalance)
   - Transactions

2. **Draw** (Tirage)
   - Cr√©√© par admin
   - Li√© √† un op√©rateur
   - Multiplicateurs configurables
   - Statut: upcoming ‚Üí pending ‚Üí completed

3. **Ticket** (Pari)
   - Achet√© par joueur
   - Li√© √† un tirage
   - 9 types possibles (NAP1-5, PERMUTATION, BANKA, CHANCE+, ANAGRAMME)
   - Statut: pending ‚Üí won/lost

4. **WithdrawalRequest** (Retrait)
   - Demand√© par joueur
   - Trait√© par admin
   - Statut: pending ‚Üí approved/rejected

5. **WinNotification** (Notification de gain)
   - Cr√©√©e automatiquement quand joueur gagne
   - Affich√©e dans l'interface joueur

6. **Transaction** (Historique)
   - Toutes les op√©rations financi√®res
   - Types: RECHARGE, BET, WIN, CONVERSION, WITHDRAWAL

### √âtape 3: Comprendre le flow principal (10 min)

**Flow complet d'un pari:**

```
1. JOUEUR s'inscrit
   ‚îî‚îÄ> POST /auth/register ‚Üí Cr√©e User

2. REVENDEUR cr√©dite le compte joueur
   ‚îî‚îÄ> POST /resellers/:id/credit-player
       ‚îú‚îÄ> D√©duit tokenBalance revendeur
       ‚îú‚îÄ> Cr√©dite balanceGame joueur
       ‚îî‚îÄ> Cr√©e transaction RECHARGE

3. JOUEUR ach√®te un ticket
   ‚îî‚îÄ> POST /tickets
       ‚îú‚îÄ> V√©rifie balanceGame >= betAmount
       ‚îú‚îÄ> D√©duit balanceGame
       ‚îú‚îÄ> Cr√©e ticket status='pending'
       ‚îî‚îÄ> Cr√©e transaction BET

4. ADMIN cr√©e un tirage
   ‚îî‚îÄ> POST /draws ‚Üí Cr√©e Draw status='upcoming'

5. [Heure du tirage passe]
   ‚îî‚îÄ> Syst√®me: Draw status ‚Üí 'pending'

6. ADMIN publie les r√©sultats
   ‚îî‚îÄ> PUT /draws/:id/results
       ‚îú‚îÄ> Met winningNumbers
       ‚îú‚îÄ> Draw status ‚Üí 'completed'
       ‚îî‚îÄ> CALCULE ET DISTRIBUE LES GAINS:
           ‚îú‚îÄ> Pour chaque ticket:
           ‚îÇ   ‚îú‚îÄ> Si gagnant:
           ‚îÇ   ‚îÇ   ‚îú‚îÄ> Cr√©dite balanceWinnings
           ‚îÇ   ‚îÇ   ‚îú‚îÄ> Cr√©e transaction WIN
           ‚îÇ   ‚îÇ   ‚îú‚îÄ> Cr√©e WinNotification
           ‚îÇ   ‚îÇ   ‚îî‚îÄ> Ticket status ‚Üí 'won'
           ‚îÇ   ‚îî‚îÄ> Sinon:
           ‚îÇ       ‚îî‚îÄ> Ticket status ‚Üí 'lost'
           ‚îî‚îÄ> Fin

7. JOUEUR voit sa notification de gain
   ‚îî‚îÄ> GET /notifications/user/:userId

8. JOUEUR demande un retrait
   ‚îî‚îÄ> POST /withdrawals
       ‚îú‚îÄ> D√©duit imm√©diatement balanceWinnings
       ‚îú‚îÄ> Cr√©e WithdrawalRequest status='pending'
       ‚îî‚îÄ> Cr√©e transaction WITHDRAWAL

9. ADMIN approuve le retrait
   ‚îî‚îÄ> PUT /withdrawals/:id/approve
       ‚îî‚îÄ> WithdrawalRequest status ‚Üí 'approved'
```

---

## üéØ PRIORIT√âS DE D√âVELOPPEMENT

### Phase 1: MVP (Semaine 1-2) ‚≠ê‚≠ê‚≠ê

**Objectif**: API fonctionnelle pour le flow de base

- [ ] Setup projet (Express/NestJS + MongoDB/PostgreSQL)
- [ ] Authentification JWT
- [ ] POST /auth/register
- [ ] POST /auth/login
- [ ] GET /auth/me
- [ ] CRUD /draws (admin)
- [ ] POST /tickets (joueur)
- [ ] GET /tickets/user/:userId
- [ ] Calcul gain NAP2 (le plus simple)
- [ ] Tests unitaires calcul gain

**Livrable**: Un joueur peut s'inscrire, acheter un ticket NAP2, et gagner.

### Phase 2: Types de Paris (Semaine 3) ‚≠ê‚≠ê

**Objectif**: Impl√©menter tous les types de paris

- [ ] Calcul gain NAP1, NAP3, NAP4, NAP5
- [ ] Calcul gain PERMUTATION
- [ ] Calcul gain BANKA
- [ ] Calcul gain CHANCE_PLUS
- [ ] Calcul gain ANAGRAMME
- [ ] Tests pour chaque type
- [ ] PUT /draws/:id/results (distribution automatique)

**Livrable**: Tous les types de paris fonctionnent.

### Phase 3: Syst√®me Complet (Semaine 4) ‚≠ê‚≠ê

**Objectif**: Features compl√®tes

- [ ] Syst√®me de revendeurs
- [ ] POST /resellers/:id/credit-player
- [ ] POST /players/:id/convert (Gains ‚Üí Jeu)
- [ ] POST /withdrawals
- [ ] PUT /withdrawals/:id/approve
- [ ] PUT /withdrawals/:id/reject
- [ ] GET /admin/stats/* (dashboard)
- [ ] Notifications de gains

**Livrable**: Application compl√®te fonctionnelle.

### Phase 4: Migration & Int√©gration (Semaine 5-6) ‚≠ê

**Objectif**: Mettre en production

- [ ] Endpoints de migration s√©curis√©s
- [ ] Migration des donn√©es localStorage
- [ ] Int√©gration frontend ‚Üî backend
- [ ] Tests E2E
- [ ] Documentation API (Swagger)
- [ ] D√©ploiement

**Livrable**: Application en production.

---

## üî• POINTS ULTRA-CRITIQUES

### 1. Calcul des Gains ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

**LE PLUS IMPORTANT DE TOUTE L'APPLICATION**

- Argent r√©el en jeu
- Doit √™tre exact √† 100%
- Tests obligatoires pour chaque type

üëâ Voir **BACKEND_SPECIFICATIONS.md** section "CALCUL DES GAINS"

### 2. Transactions Atomiques ‚ö†Ô∏è‚ö†Ô∏è

**Toutes les op√©rations financi√®res doivent √™tre atomiques**

Exemple: Cr√©dit par revendeur
```javascript
// ‚ùå MAUVAIS
resellerBalance -= 5000;
playerBalance += 5000; // ‚ö†Ô∏è Si crash ici, argent perdu !

// ‚úÖ BON
await db.transaction(async (session) => {
  await updateReseller(..., { session });
  await updatePlayer(..., { session });
  await createTransaction(..., { session });
});
```

### 3. Double Solde ‚ö†Ô∏è

**Les joueurs ont 2 soldes s√©par√©s:**
- `balanceGame` ‚Üí Pour jouer
- `balanceWinnings` ‚Üí Pour retirer

**R√®gles:**
- ‚úÖ Gains ‚Üí Jeu (conversion autoris√©e)
- ‚ùå Jeu ‚Üí Gains (INTERDIT)
- ‚úÖ Retrait depuis Gains uniquement

### 4. S√©curit√© ‚ö†Ô∏è

- üîí Hasher TOUS les mots de passe (bcrypt >= 10 rounds)
- üîí Valider TOUTES les entr√©es
- üîí JWT avec expiration courte (15min)
- üîí Rate limiting sur tous les endpoints
- üîí CORS configur√© strictement
- üîí HTTPS en production obligatoire

---

## üß™ TESTS CRITIQUES

**Avant de dire "c'est pr√™t", ces tests DOIVENT passer:**

### Tests de Calcul de Gains:

```javascript
describe('Calcul NAP2', () => {
  test('Doit gagner si les 2 num√©ros sont tir√©s', () => {
    const result = checkNAP2Win(
      [12, 34],           // Num√©ros joueur
      [12, 34, 56, 78, 90], // Num√©ros gagnants
      1000,               // Mise
      500                 // Multiplicateur
    );
    expect(result).toBe(500000); // 1000 √ó 500
  });

  test('Ne doit pas gagner si un seul num√©ro est tir√©', () => {
    const result = checkNAP2Win(
      [12, 99],
      [12, 34, 56, 78, 90],
      1000,
      500
    );
    expect(result).toBe(0);
  });
});

// Idem pour NAP1, NAP3, NAP4, NAP5, PERMUTATION, BANKA, CHANCE_PLUS, ANAGRAMME
```

### Tests de Transactions:

```javascript
describe('Achat de ticket', () => {
  test('Doit d√©duire le montant du solde', async () => {
    const initialBalance = 5000;
    await buyTicket(userId, drawId, 1000);
    const newBalance = await getPlayerBalance(userId);
    expect(newBalance).toBe(4000);
  });

  test('Doit refuser si solde insuffisant', async () => {
    const balance = 500;
    await expect(
      buyTicket(userId, drawId, 1000)
    ).rejects.toThrow('INSUFFICIENT_BALANCE');
  });
});
```

---

## üìû QUESTIONS FR√âQUENTES

### Q: Quelle base de donn√©es utiliser ?
**R**: MongoDB ou PostgreSQL. MongoDB si vous pr√©f√©rez la flexibilit√©, PostgreSQL si vous pr√©f√©rez les relations strictes.

### Q: Comment g√©rer les multiplicateurs ?
**R**: Chaque Draw a ses propres multiplicateurs. Ne PAS utiliser les valeurs par d√©faut, mais celles du tirage sp√©cifique.

### Q: Comment calculer les gains PERMUTATION ?
**R**: G√©n√©rer toutes les combinaisons de 2 num√©ros, puis pour chaque combinaison, v√©rifier si TOUS ses num√©ros sont dans les gagnants. Gain = (mise / nb_combinaisons) √ó multiplicateur par combinaison gagnante.

### Q: Quand distribuer les gains ?
**R**: Automatiquement quand l'admin publie les r√©sultats (PUT /draws/:id/results). Le backend doit parcourir tous les tickets du tirage et calculer les gains.

### Q: Comment g√©rer les retraits rejet√©s ?
**R**: Si rejet, RE-CR√âDITER le balanceWinnings du joueur (l'argent avait √©t√© d√©duit lors de la demande).

### Q: Faut-il un syst√®me de cache ?
**R**: Optionnel pour la v1. Redis peut √™tre ajout√© plus tard pour les stats en temps r√©el.

---

## üõ†Ô∏è SETUP RAPIDE (Exemple Node.js + MongoDB)

```bash
# 1. Cr√©er le projet
mkdir loto-happy-backend
cd loto-happy-backend
npm init -y

# 2. Installer les d√©pendances
npm install express mongoose jsonwebtoken bcrypt cors dotenv
npm install --save-dev nodemon jest supertest

# 3. Structure de base
mkdir -p src/{config,models,controllers,services,middlewares,routes,utils}
touch src/index.js
touch .env

# 4. .env
echo "DATABASE_URL=mongodb://localhost:27017/lotohappy" >> .env
echo "JWT_SECRET=votre_secret_ultra_securise" >> .env
echo "PORT=5000" >> .env

# 5. Lancer
npm run dev
```

---

## ‚úÖ CHECKLIST DE D√âMARRAGE

Avant de commencer √† coder:

- [ ] J'ai lu **BACKEND_HANDOFF.md** enti√®rement
- [ ] J'ai parcouru **BACKEND_SPECIFICATIONS.md**
- [ ] Je comprends le flow principal
- [ ] Je connais les 6 entit√©s principales
- [ ] J'ai identifi√© les points critiques (calcul gains, transactions atomiques)
- [ ] J'ai choisi ma stack technique (Node.js/Python/Java + DB)
- [ ] J'ai un environnement de dev configur√©
- [ ] J'ai acc√®s aux 4 documents de spec
- [ ] Je sais o√π trouver l'aide (documents + code frontend)

---

## üéâ C'EST PARTI !

Vous √™tes pr√™t ! Voici votre roadmap:

1. **Aujourd'hui**: Lire BACKEND_HANDOFF.md + BACKEND_SPECIFICATIONS.md
2. **Demain**: Setup projet + Authentification
3. **Cette semaine**: MVP (Flow de base avec NAP2)
4. **Prochaines semaines**: Compl√©ter tous les types de paris
5. **Ensuite**: Migration + Int√©gration + Production

**N'oubliez pas:**
- üß™ Tester constamment
- üìñ Consulter les specs r√©guli√®rement  
- üîí S√©curit√© d'abord
- üí¨ Poser des questions si besoin

**Bon d√©veloppement ! üöÄ**

---

**Documents √† consulter:**
1. ‚úÖ **START_HERE.md** (ce fichier)
2. ü§ù **BACKEND_HANDOFF.md** - Vue d'ensemble et points critiques
3. üìã **BACKEND_SPECIFICATIONS.md** - R√©f√©rence technique compl√®te
4. üì° **API_EXAMPLES.md** - Exemples d'impl√©mentation
5. üîÑ **DATA_MIGRATION_GUIDE.md** - Guide de migration

**Code source frontend:**
- `/utils/auth.ts` - Syst√®me d'authentification
- `/utils/games.ts` - Configuration op√©rateurs et paris
- `/utils/draws.ts` - Gestion tirages et calcul gains
- `/components/admin/` - Interface admin

---

**Version:** 1.0  
**Date:** 29 Octobre 2025  
**Statut:** üöÄ Pr√™t pour d√©veloppement
